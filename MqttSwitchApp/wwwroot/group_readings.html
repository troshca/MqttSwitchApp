<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Показания группы</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

            .sidenav a {
                padding: 8px 8px 8px 32px;
                text-decoration: none;
                font-size: 20px;
                color: #818181;
                display: block;
                transition: 0.3s;
            }

                .sidenav a:hover {
                    color: #f1f1f1;
                }

            .sidenav .closebtn {
                position: absolute;
                top: 0;
                right: 25px;
                font-size: 36px;
                margin-left: 50px;
            }

            .sidenav a.active {
                color: #f1f1f1;
                font-weight: bold;
            }

        .main {
            margin-left: 0;
            transition: margin-left .5s;
            padding: 20px;
        }

        .hamburger {
            font-size: 30px;
            cursor: pointer;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 2;
        }

        .group-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .group-params {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .socket-container {
            margin: 10px 0;
        }

        .spoiler {
            display: none;
            margin-left: 20px;
        }

            .spoiler.active {
                display: block;
            }

        .spoiler-toggle {
            cursor: pointer;
            font-weight: bold;
        }

            .spoiler-toggle:hover {
                text-decoration: underline;
            }

        .rms-data, .inst-data {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="hamburger" onclick="toggleNav()">☰</div>
    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="toggleNav()">×</a>
        <a href="/" id="homeLink">Управление розетками</a>
        <!-- Пункты меню для групп добавляются динамически -->
    </div>

    <div class="main">
        <div class="group-header">
            <h1 id="groupTitle">Группа</h1>
            <div class="group-params">
                <span>RMS Напряжение: <span id="voltageRms">0</span> В</span>
                <span>Мгновенное Напряжение: <span id="voltageInst">0</span> В</span>
                <span>Частота RMS: <span id="freqRms">0</span> Гц</span>
                <span>Мгновенная Частота: <span id="freqInst">0</span> Гц</span>
            </div>
        </div>

        <div id="socketsContainer"></div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/mqttHub")
            .build();

        // Получаем номер группы из URL
        const urlParams = new URLSearchParams(window.location.search);
        const groupIndex = parseInt(urlParams.get("group")) || 0;
        const groups = [
            { name: "Группа 1", switchCount: 9, startIndex: 1, modbusOffset: 0 },
            { name: "Группа 2", switchCount: 9, startIndex: 10, modbusOffset: 1 }
        ];
        const group = groups[groupIndex] || groups[0];

        // Устанавливаем заголовок
        document.getElementById("groupTitle").textContent = group.name;

        // Генерация меню
        const sidenav = document.getElementById("mySidenav");
        groups.forEach((group, index) => {
            const link = document.createElement("a");
            link.href = `/group_readings?group=${index}`;
            link.textContent = `Показания ${group.name}`;
            if (index === groupIndex) link.classList.add("active");
            sidenav.appendChild(link);
        });
        const settingsLink = document.createElement("a");
        settingsLink.href = "/settings";
        settingsLink.textContent = "Настройки";
        sidenav.appendChild(settingsLink);

        // Генерация розеток
        const socketsContainer = document.getElementById("socketsContainer");
        for (let i = 0; i < group.switchCount; i++) {
            const socketDiv = document.createElement("div");
            socketDiv.className = "socket-container";
            socketDiv.innerHTML = `
                    <div class="spoiler-toggle" onclick="toggleSpoiler('socket${i}')">Розетка ${group.startIndex + i}</div>
                    <div id="socket${i}" class="spoiler">
                        <div class="rms-data">
                            <h4>RMS Показания</h4>
                            <p>Напряжение: <span id="socket${i}_voltageRms">0</span> В</p>
                            <p>Ток: <span id="socket${i}_currentRms">0</span> А</p>
                            <p>Активная мощность: <span id="socket${i}_activePowerRms">0</span> Вт</p>
                            <p>Реактивная мощность: <span id="socket${i}_reactivePowerRms">0</span> вар</p>
                            <p>Частота: <span id="socket${i}_freqRms">0</span> Гц</p>
                        </div>
                        <div class="inst-data">
                            <h4>Мгновенные Показания</h4>
                            <p>Напряжение: <span id="socket${i}_voltageInst">0</span> В</p>
                            <p>Ток: <span id="socket${i}_currentInst">0</span> А</p>
                            <p>Активная мощность: <span id="socket${i}_activePowerInst">0</span> Вт</p>
                            <p>Реактивная мощность: <span id="socket${i}_reactivePowerInst">0</span> вар</p>
                            <p>Частота: <span id="socket${i}_freqInst">0</span> Гц</p>
                        </div>
                    </div>
                `;
            socketsContainer.appendChild(socketDiv);
        }

        function toggleSpoiler(socketId) {
            const spoiler = document.getElementById(socketId);
            spoiler.classList.toggle("active");
        }

        function toggleNav() {
            const sidenav = document.getElementById("mySidenav");
            const main = document.querySelector(".main");
            if (sidenav.style.width === "250px") {
                sidenav.style.width = "0";
                main.style.marginLeft = "0";
            } else {
                sidenav.style.width = "250px";
                main.style.marginLeft = "250px";
            }
        }

        function combineRegisters(low, high) {
            return (high << 16) | low;
        }

        function updateReadings(data) {
            try {
                if (!Array.isArray(data)) {
                    console.error("Invalid data format - expected array:", data);
                    return;
                }

                const groupRegisterCount = 20;
                const socketRegisterCount = 20;
                const totalRegisters = groupRegisterCount + group.switchCount * socketRegisterCount;

                if (data.length < totalRegisters) {
                    console.error(`Not enough data. Expected ${totalRegisters}, got ${data.length}`);
                    return;
                }

                // Групповые параметры (первые 20 регистров)
                document.getElementById("voltageRms").textContent = combineRegisters(data[0], data[1]) / 1000;
                document.getElementById("voltageInst").textContent = combineRegisters(data[10], data[11]) / 1000;
                document.getElementById("freqRms").textContent = combineRegisters(data[8], data[9]) / 1000;
                document.getElementById("freqInst").textContent = combineRegisters(data[18], data[19]) / 1000;

                // Параметры розеток (остальные регистры)
                for (let i = 0; i < group.switchCount; i++) {
                    const offset = groupRegisterCount + i * socketRegisterCount;

                    // RMS
                    document.getElementById(`socket${i}_voltageRms`).textContent = combineRegisters(data[offset], data[offset + 1]) / 1000;
                    document.getElementById(`socket${i}_currentRms`).textContent = combineRegisters(data[offset + 2], data[offset + 3]) / 1000;
                    document.getElementById(`socket${i}_activePowerRms`).textContent = combineRegisters(data[offset + 4], data[offset + 5]) / 1000;
                    document.getElementById(`socket${i}_reactivePowerRms`).textContent = combineRegisters(data[offset + 6], data[offset + 7]) / 1000;
                    document.getElementById(`socket${i}_freqRms`).textContent = combineRegisters(data[offset + 8], data[offset + 9]) / 1000;

                    // Мгновенные
                    document.getElementById(`socket${i}_voltageInst`).textContent = combineRegisters(data[offset + 10], data[offset + 11] / 1000);
                    document.getElementById(`socket${i}_currentInst`).textContent = combineRegisters(data[offset + 12], data[offset + 13]) / 1000;
                    document.getElementById(`socket${i}_activePowerInst`).textContent = combineRegisters(data[offset + 14], data[offset + 15] / 1000);
                    document.getElementById(`socket${i}_reactivePowerInst`).textContent = combineRegisters(data[offset + 16], data[offset + 17] / 1000);
                    document.getElementById(`socket${i}_freqInst`).textContent = combineRegisters(data[offset + 18], data[offset + 19]) / 1000;
                }
            } catch (err) {
                console.error("Error updating readings:", err);
            }
        }

        connection.on("ReceiveModbusData", (readings) => {
            console.log("Received modbus data:", readings);
            try {
                if (Array.isArray(readings)) {
                    updateReadings(readings);
                } else {
                    console.error("Invalid data format - expected array:", readings);
                }
            } catch (err) {
                console.error("Error processing modbus data:", err);
            }
        });;

        connection.start()
            .then(() => {
                console.log("SignalR connected");
                // Убрано connection.invoke("RequestModbusData", ...)
            })
            .catch(err => console.error("SignalR connection error:", err));
    </script>
</body>
</html>